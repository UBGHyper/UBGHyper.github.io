<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <title>Play Game - UBGHyper</title>
      <meta name="viewport" content="width=device-width,initial-scale=1.0">
      <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@700;400&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="../assets/css/main.css">
      <link rel="icon" type="image/x-icon" href="assets/img/icon/main.png">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8895667704497452"
         crossorigin="anonymous"></script>
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-VE9J0CCHWZ"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="../assets/css/main.css"> </head>
      <style>


         /* --- playtime graph new style --- */
         .chart-container {
         max-width: 900px;
         margin: 32px auto 32px auto;
         background: linear-gradient(135deg,#23232e 65%,#24243b 100%);
         border-radius: 17px;
         padding: 18px 18px 40px 18px;
         box-shadow: 0 6px 20px #000c, 0 1px 2px #f1ba9030 inset;
         border: 2px solid #ffd09c55;
         }
         #playtimeChart {
         background: #171818;
         border-radius: 11px;
         width: 100%;
         max-width: 850px;
         height: 260px;
         margin: auto;
         display: block;
         box-shadow: 0 3px 24px #ffd09c24;
         border: 1.2px solid #ffd09c30;
         }
         .game-iframe {
         width: 100%;
         height: 75vh;
         border: none;
         background: #121212;
         border-radius: 0 0 16px 16px;
         display: block;
         margin: 0;
         max-height: 80vh;
         }
         .fullscreen-btn {
         position: absolute;
         bottom: 14px;
         right: 18px;
         z-index: 10;
         background: #16171c;
         color: #ffd09c;
         border: none;
         border-radius: 6px;
         padding: 7px 14px;
         box-shadow: 0 2px 8px #0006;
         cursor: pointer;
         font-size: 1.1em;
         opacity: 0.95;
         transition: background 0.1s, opacity 0.2s;
         display: flex;
         align-items: center;
         gap: 6px;
         }
         .fullscreen-btn:hover, .fullscreen-btn:focus {
         background: #ffd09c;
         color: #16171c;
         opacity: 1;
         }
         .fullscreen-btn svg {
         width: 18px;
         height: 18px;
         vertical-align: middle;
         fill: currentColor;
         }
         /* Info panel below iframe */
         .game-info-container {
         max-width:1200px;
         margin: 18px auto 0 auto;
         padding: 26px 28px 20px 28px;
         background: #191a22;
         border-radius: 16px;
         text-align: left;
         }
         .game-title {
         font-family: 'Rubik', sans-serif;
         font-weight: 700;
         font-size: 2.2em;
         color: #ffd09c;
         line-height: 1.1;
         letter-spacing: .5px;
         margin: 0;
         flex: 1 1 auto;
         }
         .game-title-bar {
         display: flex;
         align-items: center;
         justify-content: space-between;
         gap: 16px;
         padding-bottom: 7px;
         }
         .game-author {
         font-size: 1em;
         margin-top: 4px;
         color: #bda893;
         font-style: italic;
         letter-spacing: .1em;
         }
         .game-playtime {
         margin-top: 16px;
         font-family: Rubik, sans-serif;
         color: #ffd09c;
         font-size: 1.15em;
         background: #23232a;
         border-radius: 20px;
         display: inline-flex;
         align-items: center;
         gap: 8px;
         padding: 7px 17px 7px 13px;
         font-weight: 700;
         box-shadow: 0 2px 16px #ffd09c22;
         position: relative;
         transition: background 0.14s;
         letter-spacing: 0.05em;
         }
         .playtime-clock-icon {
         display: inline-block;
         margin-right: 0px;
         width: 22px;
         height: 22px;
         vertical-align: -5px;
         fill: #ffd09c;
         filter: drop-shadow(0 2px 4px #9f613c49);
         }
         /* Details & Recommendations Row */
         .game-desc-recommend-row {
         max-width: 1200px;
         margin:18px auto 0 auto;
         width: 100%;
         display: flex;
         gap: 32px;
         justify-content: space-between;
         align-items: flex-start;
         background: #18181e;
         padding: 30px 28px 32px 28px;
         box-sizing: border-box;
         border-radius: 15px;
         }
         .game-desc-panel, .game-recommend-panel {
         flex: 1 1 0;
         background: #21212a;
         border-radius: 13px;
         box-shadow: 0 1px 6px #1b151675;
         padding: 20px 22px 16px 22px;
         min-width: 0;
         }
         .desc-title {
         font-family: 'Rubik', sans-serif;
         color: #ffd09c;
         font-weight: 700;
         font-size: 1.06em;
         margin-bottom: 10px;
         letter-spacing: .1em;
         }
         #descDetails {
         color: #ffe3bd;
         font-family: Rubik, sans-serif;
         font-size: 1.08em;
         line-height: 1.65;
         white-space: pre-line;
         margin-bottom: 0;
         }
         #recommendedList {
         display: flex; flex-direction: column;
         gap: 12px;
         }
         .recommend-game-link {
         display: flex; align-items: center;
         background: #18181d;
         border-radius: 8px;
         color: #ffd09c;
         font-family: 'Rubik', sans-serif;
         font-size: 1.01em;
         font-weight: 600;
         padding: 10px 12px;
         text-decoration: none;
         gap: 10px;
         transition: background 0.11s, box-shadow 0.15s  ;
         border: 1.2px solid #261e19;
         }
         .recommend-game-link:hover {
         background: #ffd09c;
         color: #271306;
         box-shadow: 0 4px 20px #ffd09c2a;
         }
         .recommend-thumb {
         width: 40px; min-width: 40px;
         height: 40px;
         border-radius: 7px;
         box-shadow: 0 0 2px #000c;
         background: #242430;
         object-fit: cover;
         margin-right: 5px;
         }
         /* --- Recently Played Section [ENHANCED] --- */
         .recently-played-section {
         max-width: 1200px;
         margin: 54px auto 32px auto;
         background: linear-gradient(135deg,#1b1e26 70%,#23232d 100%);
         border-radius: 20px;
         padding: 24px 26px 20px 26px;
         box-shadow: 0 4px 24px #000a, 0 0px 1.5px #ffd09c33;
         position: relative;
         overflow: hidden;
         }
         .recently-title {
         color: #ffd09c;
         font-family: Rubik,sans-serif;
         font-size: 1.17em;
         margin-bottom: 18px;
         font-weight: 700;
         letter-spacing: 0.13em;
         display: flex;
         align-items: center;
         gap: 8px;
         }
         .recently-title span {
         font-size: 1.26em;
         }
         .recently-games {
         display: flex;
         flex-wrap: wrap;
         gap: 21px 19px;
         padding-bottom: 13px;
         justify-content: flex-start;
         }
         .recent-game-card {
         display: flex;
         flex-direction: column;
         align-items: center;
         background: linear-gradient(120deg, #24242a 74%, #2b2120 100%);
         border-radius: 14px;
         padding: 15px 19px 16px 19px;
         box-shadow: 0 4px 18px #130a1537;
         border: 2.2px solid #ffdfbc18;
         transition: box-shadow 0.17s, background 0.17s, transform 0.11s;
         text-decoration: none;
         color: #ffd09c;
         min-width: 140px;
         max-width: 164px;
         flex: 1 1 0;
         position: relative;
         cursor: pointer;
         overflow: visible;
         }
         .recent-game-card::after {
         content: "";
         display: block;
         position: absolute;
         left: 8px; top: 8px;
         width: 12px; height: 12px;
         background: #ffd09c99;
         border-radius: 50%;
         box-shadow: 0 1px 6px #ffd09c55;
         opacity: 0;
         transition: opacity 0.18s;
         }
         .recent-game-card:hover,
         .recent-game-card:focus {
         background: linear-gradient(121deg, #ffd09c 81%, #f8cd8e 100%);
         color: #2d1607;
         box-shadow: 0 6px 32px #ffd09c4c;
         border-color: #ffd09cb5;
         transform: translateY(-3px) scale(1.04);
         z-index: 2;
         }
         .recent-game-card:hover .recent-thumb,
         .recent-game-card:focus .recent-thumb {
         border-color: #7c502b;
         box-shadow: 0 3px 14px #ffd09c1c;
         }
         .recent-game-card:hover::after, .recent-game-card:focus::after {
         opacity: 1;
         }
         .recent-thumb {
         width: 74px;
         height: 74px;
         border-radius: 11px;
         margin-bottom: 12px;
         background: #18181e;
         object-fit: cover;
         box-shadow: 0 2.5px 11px #0007, 0 0.5px 1.5px #ffd09c33;
         border: 2.6px solid #ebce9e;
         transition: border 0.17s, box-shadow 0.16s;
         }
         .recent-game-name {
         text-align: center;
         font-family: Rubik,sans-serif;
         font-size: 1.08em;
         max-width: 104px;
         font-weight: 700;
         margin-bottom: 3px;
         letter-spacing: .01em;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         .recent-game-author {
         font-size: 0.92em;
         color: #987947;
         text-align: center;
         max-width: 108px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         opacity: 0.92;
         }
         .recent-last-played {
         font-size: 0.76em;
         color: #d4be85;
         background: #18171197;
         border-radius: 10px;
         padding: 2px 8px;
         margin-top: 7px;
         opacity: .92;
         font-family: Rubik,sans-serif;
         }

         .save-editor-overlay {
  position: fixed;
  inset: 0;
  background: rgba(22,19,12, 0.78);
  backdrop-filter: blur(3.5px) saturate(130%);
  z-index: 9000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: overlayFadeIn 0.22s ease;
}
@keyframes overlayFadeIn {
  from { opacity: 0;}
  to { opacity: 1;}
}
.save-editor-popup {
  background: linear-gradient(135deg, #1f1812 65%, #2e1e16 100%);
  border-radius: 20px;
  max-width: 420px;
  width: 94vw;
  box-shadow: 0 7px 34px #000C, 0 0px 2px #ffd09c38 inset;
  border: 2.5px solid #ffd09c99;
  padding: 36px 30px 28px 30px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 23px;
  position: relative;
  animation: popupSpring 0.30s cubic-bezier(.23,1.23,.30,1);
}
@keyframes popupSpring {
  from { opacity: 0; transform: scale(.82) translateY(24px);}
  67%  { transform: scale(1.04);}
  to   { opacity: 1; transform: scale(1) translateY(0);}
}
.save-editor-title {
  font-family: 'Rubik', sans-serif;
  color: #ffd09c;
  font-size: 1.42em;
  font-weight: 700;
  text-align: center;
  letter-spacing: .09em;
  margin-bottom: 5px;
  text-shadow: 0 2px 11px #d2a1692a, 0 .5px 0 #0005;
}
.save-editor-fields {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 7px;
}
.save-editor-label {
  color: #ffe6c5;
  font-weight: 600;
  font-size: 1.08em;
  margin-bottom: 7px;
  letter-spacing: .11em;
  font-family: Rubik,sans-serif;
}
.save-editor-input, .save-editor-textarea {
  width: 100%;
  padding: 10px 14px;
  font-size: 1.07em;
  color: #ffd09c;
  background: #23232b;
  border: 1.7px solid #facc9930;
  border-radius: 8px;
  font-family: 'Fira Mono', 'Rubik', monospace, sans-serif;
  resize: vertical;
  min-height: 40px;
  outline: none;
  box-shadow: 0 1.5px 10px #ffd09c0a inset;
  transition: border 0.15s, box-shadow 0.15s;
}
.save-editor-input:focus, .save-editor-textarea:focus {
  border: 1.8px solid #ffd09c;
  box-shadow: 0 2px 18px #ffd09c22;
  background: #241e10;
}
.save-editor-btns {
  display: flex;
  gap: 18px;
  margin-top: 4px;
  justify-content: flex-end;
}
.save-editor-btn {
  background: #ffd09c;
  color: #2a180b;
  border: none;
  border-radius: 8px;
  font-family: Rubik, sans-serif;
  font-size: 1.08em;
  font-weight: 700;
  padding: 8px 26px;
  cursor: pointer;
  box-shadow: 0 4px 16px #ffd09c22, 0 .5px 1.5px #000a inset;
  transition: background .14s, color .13s, transform .12s, box-shadow .16s;
  letter-spacing: .06em;
}
.save-editor-btn:hover,
.save-editor-btn:focus {
  background: #2a180b;
  color: #ffd09c;
  box-shadow: 0 7px 20px #ffd09c4a;
  transform: translateY(-1px) scale(1.04);
}
.save-editor-btn.cancel {
  background: #23232b;
  color: #ffd09c;
  border: 1.2px solid #ffd09cab;
  box-shadow: 0 2.5px 7px #ffd09c11;
}
.save-editor-btn.cancel:hover,
.save-editor-btn.cancel:focus {
  background: #ffd09c44;
  color: #231b11;
}

.save-editor-close {
  position: absolute;
  top: 17px;
  right: 20px;
  background: none;
  border: none;
  color: #ffd09c;
  font-size: 1.8em;
  cursor: pointer;
  opacity: 0.80;
  z-index: 10;
  transition: opacity 0.13s;
  line-height: 1;
}
.save-editor-close:hover,
.save-editor-close:focus {
  opacity: 1;
  color: #ffe0a3;
}

@media (max-width: 540px) {
  .save-editor-popup {
    border-radius: 13px;
    padding: 18px 7vw 16px 7vw;
  }
  .save-editor-title { font-size: 1.14em; }
}
         @media (max-width:900px){
         .recent-game-card {min-width:110px;max-width:120px;padding:7px 6px;}
         .recent-thumb {width:48px;height:48px;}
         .recent-game-name {max-width:80px;}
         .recent-game-author {max-width:80px;}
         }
         @media (max-width:650px){
         .recently-games {gap: 7px 6px;}
         .recent-game-card {min-width:80px;max-width:98px;}
         .recent-thumb {width:34px;height:34px;}
         .recent-game-name,.recent-game-author {max-width:58px;}
         }
         @media (max-width:900px){
         .game-frame { border-radius: 10px; }
         .game-iframe { height: 62vw; }
         .game-info-container,
         .game-desc-recommend-row { padding: 12px 2vw 10px 2vw;}
         }
         @media (max-width: 700px) {
         .game-title-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
         .game-desc-recommend-row { flex-direction: column; gap:20px; }
         }
         @media (max-width: 750px) {
         .recently-games {gap: 9px;}
         .recent-game-card {min-width:85px;max-width:102px;padding:6px 4px;}
         .recent-thumb {width:35px;height:35px;}
         .recent-game-name {max-width:64px;}
         .recent-game-author {max-width:64px;}
         }
      </style>
   </head>
<script>
const gameKey = new URLSearchParams(location.search).get('game');
let t0 = Date.now();
window.addEventListener('beforeunload', function() {
  if (!gameKey) return;
  let t1 = Date.now();
  let dt = Math.max(0, t1 - t0);
  let stats = JSON.parse(localStorage.getItem('gameStats') || '{}');
  stats[gameKey] = stats[gameKey] || { clicks: 0, time: 0 };
  stats[gameKey].time += dt;
  localStorage.setItem('gameStats', JSON.stringify(stats));
});
</script>

   <body>
      <nav>
         <a href="index.html" class="active">Home</a>
         <a href="games.html">All Games</a>
         <a href="favourites.html">Favourites</a>
         <a href="about.html">About</a>
      </nav>
      <div class="game-frame">
         <iframe class="game-iframe" id="frame" allowfullscreen></iframe>
         <button class="fullscreen-btn" id="fullscreenBtn" title="Fullscreen">
            <svg viewBox="0 0 24 24">
               <path d="M7 14H5v5h5v-2H7v-3zm-2-7v5h2V7h3V5H5v2zm12 10h-3v2h5v-5h-2v3zm0-10v3h2V5h-5v2h3z"/>
            </svg>
            Fullscreen
         </button>
      </div>
    <div class="game-info-container">
<div class="game-title-bar" style="align-items:center;">
  <div class="game-title" id="gameTitle"></div>
  <button id="editSaveBtn" style="margin-left:auto;background:#262736;color:#ffd09c;border:none;padding:8px 19px;font-family:Rubik,sans-serif;font-weight:700;font-size:1em;border-radius:16px;box-shadow:0 2px 8px #ffd09c18;cursor:pointer;transition:.13s;margin-right:5px;">
    &#9874; Edit Save
  </button>
</div>
<div class="game-author" id="gameAuthor"></div>
<div style="display: flex;align-items:center;gap:8px;">
  <div class="game-playtime" id="gamePlaytime"></div>
</div>
<div id="editSaveModal" style="display:none;position:fixed;z-index:99999;left:0;top:0;width:100vw;height:100vh;background:#222d4280;backdrop-filter:blur(1.5px);align-items:center;justify-content:center;">
  <div style="background:#191b20;color:#fff;padding:24px;min-width:300px;max-width:90vw;border-radius:12px;box-shadow:0 3px 30px #000a;position:relative;">
    <button id="closeEditSaveModal" style="position:absolute;top:13px;right:14px;font-size:1.2em;background:none;border:none;color:#f4b135;cursor:pointer;">&times;</button>
    <h2 style="margin-top:0;font-family:Rubik,sans-serif;font-weight:800;color:#ffd09c;">Edit Save Data</h2>
    <div style="margin-bottom:8px;font-size:.97em;color:#ffe3bd;">
      Edit the <b>localStorage</b> and <b>playtime</b> for this game.<br>
      Advanced: Edit <b>IndexedDB - Playtime per Day</b>.
    </div>
    <fieldset style="border:1.2px solid #ffd09c55;border-radius:7px;padding:11px 17px;margin-bottom:14px;">
      <legend style="color:#ffd09c;font-size:0.95em;font-family:Rubik;">localStorage <span style="color:#828b32;">(playtime/Game stats)</span></legend>
      <label for="localStoragePlaytime">playtime_<span style="font-family:monospace">${slug || ''}</span>:</label>
      <input type="number" id="localStoragePlaytime" min="0" style="width:90px;font-size:1em;padding:2px 7px;margin-bottom: 7px;"> seconds
      <br>
      <label for="gameStats">gameStats:</label>
      <textarea id="gameStats" style="width:98%;height:54px;font-size:0.95em;margin-bottom:7px;"></textarea>
      <br>
      <button id="saveLocalStorageBtn" style="background:#ffd09c;color:#21212a;border:none;padding:5px 14px;border-radius:7px;font-weight:700;cursor:pointer;">Save localStorage</button>
    </fieldset>
    <fieldset style="border:1.2px solid #bcd15b89;border-radius:7px;padding:10px 14px;">
      <legend style="color:#cee971;font-size:0.95em;font-family:Rubik;">IndexedDB "GamePlaytimeDB"</legend>
      <div style="font-size:.95em;">Edit any date's playtime (minutes):</div>
      <div id="idbPlayData" style="margin-top:7px"></div>
      <button id="saveIDBPlaytimeBtn" style="margin-top:9px;background:#cee971;color:#2f3905;border:none;padding:5px 14px;border-radius:7px;font-weight:700;cursor:pointer;">Save IndexedDB</button>
    </fieldset>
  </div>
</div>
     </div>
      </div>
      <div class="game-desc-recommend-row">
         <div class="game-desc-panel">
            <div class="desc-title">About this game</div>
            <div id="descDetails"></div>
         </div>
         <div class="game-recommend-panel">
            <div class="desc-title">Recommended Games</div>
            <div id="recommendedList"></div>
         </div>
      </div>
      <!-- UPDATED: Playtime Graph gets style container -->
      <div class="chart-container">
         <h2 class="chart-heading">
            Playtime per Day
         </h2>
         <canvas id="playtimeChart"></canvas>
      </div>
      
      <!-- NEW: Recently Played Games section -->
      <div class="recently-played-section" id="recentlyPlayedSection" style="display:none;">
         <div class="recently-title"><span style="font-size:1.1em;">&#x1F4DA;</span> Recently Played</div>
         <div class="recently-games" id="recentlyPlayedGames"></div>
      </div>
      <script>
        // ------ EDIT SAVE POPUP FUNCTIONALITY -----
(function() {
  const editBtn = document.getElementById('editSaveBtn');
  const modal = document.getElementById('editSaveModal');
  const closeBtn = document.getElementById('closeEditSaveModal');
  const playtimeInput = document.getElementById('localStoragePlaytime');
  const gameStatsTA = document.getElementById('gameStats');
  const saveLocalBtn = document.getElementById('saveLocalStorageBtn');
  const idbPlayDataBox = document.getElementById('idbPlayData');
  const saveIDBBtn = document.getElementById('saveIDBPlaytimeBtn');
  let idbRows = [];
  function openModal() {
    // localStorage: load values
    playtimeInput.value = localStorage.getItem("playtime_" + slug) || 0;
    gameStatsTA.value = JSON.stringify(JSON.parse(localStorage.getItem('gameStats')||'{}'),null,2);

    // IndexedDB: load values
    idbPlayDataBox.innerHTML = "<div style='font-size:.94em;color:#fff1cd;'>Loading...</div>";
    getPlaytimeDays(slug).then(arr => {
      if(!arr.length){
        idbPlayDataBox.innerHTML = "<span style='color:#efa750;font-size:1em;'>No IndexedDB data for this game yet.</span>";
        idbRows = [];
        return;
      }
      idbPlayDataBox.innerHTML = arr.map((row,i)=>`
        <div style="margin-bottom:5px;">
          <span style="display:inline-block;width:88px;font-family:monospace;color:#ffd09c">${row.date}</span> 
          <input class="idbSeconds" type="number" min="0" data-i="${i}" style="width:64px;padding:1px 6px;" value="${Math.round(row.seconds/60)}"> minutes
        </div>
      `).join('');
      idbRows = arr;
    });

    modal.style.display = "flex";
  }
  editBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', ()=>{modal.style.display='none';});

  // localStorage Save
  saveLocalBtn.addEventListener('click',()=>{
    localStorage.setItem("playtime_" + slug, Number(playtimeInput.value));
    try {
      const val = JSON.parse(gameStatsTA.value);
      localStorage.setItem('gameStats', JSON.stringify(val));
      alert("localStorage updated!");
    } catch(e) {
      alert("Invalid JSON in gameStats.");
    }
    // update onscreen playtime counter
    updatePlaytimeCounter(formatSeconds(Number(playtimeInput.value)));
  });

  // IndexedDB Save
  saveIDBBtn.addEventListener('click',()=>{
    // For each .idbSeconds, update corresponding row
    const fields = idbPlayDataBox.querySelectorAll('.idbSeconds');
    // Open DB only once, run all updates
    openPlaytimeDB().then(db=>{
      const tx = db.transaction('playtimes','readwrite');
      const store = tx.objectStore('playtimes');
      fields.forEach(f=>{
        let i = Number(f.dataset.i);
        let minutes = Number(f.value);
        let d = {...idbRows[i]};
        d.seconds = Math.max(0, Math.round(minutes*60));
        store.put(d);
      });
      tx.oncomplete = () => {
        db.close();
        alert("IndexedDB saved!");
        getPlaytimeDays(slug).then(drawPlaytimeChart);
      };
    });
  });

  // Modal close on backdrop click
  modal.addEventListener('mousedown',e=>{
    if(e.target===modal) modal.style.display='none';
  });
})();

         document.getElementById('fullscreenBtn').addEventListener('click', function() {
           const iframe = document.getElementById('frame');
           if      (iframe.requestFullscreen)        iframe.requestFullscreen();
           else if (iframe.webkitRequestFullscreen)  iframe.webkitRequestFullscreen();
           else if (iframe.mozRequestFullScreen)     iframe.mozRequestFullScreen();
           else if (iframe.msRequestFullscreen)      iframe.msRequestFullscreen();
         });
         
         // ------ Playtime Format: only show largest time unit -----
         function formatSeconds(sec) {
           if (sec < 60) return `${sec} second${sec===1?'':'s'}`;
           if (sec < 3600) {
             const m = Math.floor(sec/60);
             return `${m} minute${m===1?'':'s'}`;
           }
           const h = Math.floor(sec/3600);
           return `${h} hour${h===1?'':'s'}`;
         }
         
         const gamesUrl = "../assets/games.json";
         const params = new URLSearchParams(location.search);
         const slug = params.get("game");
         
         function showNotFound() {
           document.getElementById("gameTitle").textContent = "Game Not Found";
           document.getElementById("frame").style.display = "none";
           document.getElementById("gameAuthor").textContent = "";
         }
         
         let playtimeInterval = null;
         
         // --- IndexedDB Helper ---
         function openPlaytimeDB() {
           return new Promise((resolve, reject) => {
             const req = indexedDB.open("GamePlaytimeDB", 1);
             req.onupgradeneeded = function(e) {
               const db = e.target.result;
               if (!db.objectStoreNames.contains("playtimes")) {
                 db.createObjectStore("playtimes", { keyPath: ["slug", "date"] });
               }
             };
             req.onsuccess = () => resolve(req.result);
             req.onerror = e => reject(e.target.error);
           });
         }
         
         function updatePlaytimeToday(slug) {
           const today = new Date().toISOString().slice(0,10);
           openPlaytimeDB().then(db => {
             const tx = db.transaction("playtimes", "readwrite");
             const store = tx.objectStore("playtimes");
             const key = [slug, today];
             store.get(key).onsuccess = function (e) {
               let data = e.target.result;
               if (!data) data = { slug, date: today, seconds: 0 };
               data.seconds++;
               store.put(data);
               db.close();
             };
           });
         }
         
         function getPlaytimeDays(slug) {
           return new Promise(resolve => {
             openPlaytimeDB().then(db => {
               const tx = db.transaction("playtimes", "readonly");
               const store = tx.objectStore("playtimes");
               const req = store.openCursor();
               const days = [];
               req.onsuccess = function(event) {
                 const cursor = event.target.result;
                 if(cursor) {
                   if(cursor.key[0] === slug) days.push(cursor.value);
                   cursor.continue();
                 } else {
                   db.close();
                   days.sort((a,b) => a.date.localeCompare(b.date));
                   resolve(days);
                 }
               };
             });
           });
         }
         
         let playChart = null;
         function drawPlaytimeChart(playArr) {
           const ctx = document.getElementById('playtimeChart').getContext('2d');
           const labels = playArr.map(x=>x.date);
           const data = playArr.map(x=>Math.round(x.seconds/60*100)/100);
         
           if (playChart) playChart.destroy();
           playChart = new Chart(ctx, {
             type: 'bar',
             data: {
               labels,
               datasets: [{
                 label: 'Minutes Played',
                 backgroundColor: (ctx) => {
                   const gradient = ctx.chart.ctx.createLinearGradient(0,0,0,260);
                   gradient.addColorStop(0, "#ffd09c");
                   gradient.addColorStop(1, "#f4b135");
                   return gradient;
                 },
                 borderColor: '#ffd09c',
                 borderWidth: 3,
                 borderRadius: 10,
                 data,
                 maxBarThickness: 38,
                 minBarLength: 2,
                 hoverBackgroundColor: "#fff0d5",
               }]
             },
             options: {
               responsive: true,
               plugins: {
                 legend: {display:false},
                 tooltip: {
                   backgroundColor: '#23232e',
                   bodyColor: '#ffd09c',
                   titleColor: '#fff',
                   borderColor: "#ffd09c",
                   borderWidth: 1.5,
                   padding: 14,
                   cornerRadius: 8
                 },
                 title: {display: false}
               },
               layout: {padding: {left: 16, right: 15, top: 10, bottom: 14}},
               scales: {
                 x: {
                   ticks: {
                     color: '#ffd09c',
                     font: { family: 'Rubik', weight: 'bold', size: 15 },
                     maxRotation: 0,
                     minRotation: 0
                   },
                   grid: {
                     color: 'rgba(255,208,156,0.09)',
                     borderColor: '#ffd09c77',
                     borderWidth: 1.7
                   }
                 },
                 y: {
                   beginAtZero: true,
                   grace: "35%",
                   ticks: {
                     color: '#ffd09c',
                     font: { family: 'Rubik', size: 14 }
                   },
                   grid: {color:'#2d2231', borderColor:"#ffd09c44"}
                 }
               }
             }
           });
         }
         
         // --- Recently Played Games LocalStorage Logic ---
         function addRecentlyPlayed(game) {
           let arr;
           try {
             arr = JSON.parse(localStorage.getItem("recentlyPlayed") || '[]');
             if (!Array.isArray(arr)) arr = [];
           } catch(e){arr=[];}
           // Remove any previous entry of this game
           arr = arr.filter(g => g.url !== game.url);
           arr.unshift({
             name: game.name,
             url: game.url,
             thumb: game.thumb,
             author: game.credits,
             time: Date.now()
           });
           // Keep only last 6
           arr = arr.slice(0,6);
           localStorage.setItem("recentlyPlayed", JSON.stringify(arr));
         }
         
         function loadRecentlyPlayed(currentSlug, gamesData) {
           let arr;
           try {
             arr = JSON.parse(localStorage.getItem("recentlyPlayed") || '[]');
           } catch(e){arr=[];}
           if (!Array.isArray(arr) || arr.length === 0) {
             document.getElementById('recentlyPlayedSection').style.display = "none";
             return;
           }
           // Filter out current game, show others
           const showArr = arr.filter(g => g.url !== currentSlug);
         
           if (!showArr.length) {
             document.getElementById('recentlyPlayedSection').style.display = "none";
             return;
           }
           document.getElementById('recentlyPlayedSection').style.display = "";
           const box = document.getElementById('recentlyPlayedGames');
           box.innerHTML = "";
           for (const g of showArr) {
             // Try to get latest thumb & title from gamesData for consistency (use fallback if outdated)
             let meta = gamesData.find(item => item.url === g.url) || g;
             const a = document.createElement("a");
             a.className = "recent-game-card";
             a.href = `play.html?game=${encodeURIComponent(meta.url)}`;
             a.innerHTML = `
               <img class="recent-thumb" src="${meta.thumb || '../assets/img/icon/main.png'}" alt="${meta.name} icon" loading="lazy">
               <span class="recent-game-name">${meta.name||'Unknown'}</span>
               <span class="recent-game-author">${meta.author||''}</span>
             `;
             box.appendChild(a);
           }
         }
         
         function updatePlaytimeCounter(val) {
           // Update with icon!
           const counter = document.getElementById('gamePlaytime');
           counter.innerHTML = `<svg class="playtime-clock-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#f2b967" stroke-width="2.5" fill="#191a22"/><path d="M12 7v5l3.5 2" stroke="#ffd09c" stroke-width="2.2" stroke-linecap="round" fill="none"/></svg> <span>Playtime: </span>${val}`;
         }
         
         function loadAndShowPlaytime(slug) {
           const saved = parseInt(localStorage.getItem('playtime_' + slug) || '0', 10);
           updatePlaytimeCounter(formatSeconds(saved));
         
           if (playtimeInterval) clearInterval(playtimeInterval);
         
           function refreshChart() { getPlaytimeDays(slug).then(drawPlaytimeChart);}
           refreshChart();
         
           playtimeInterval = setInterval(() => {
             if (document.hasFocus()) {
               let playtime = parseInt(localStorage.getItem('playtime_' + slug) || '0', 10);
               playtime++;
               localStorage.setItem('playtime_' + slug, playtime);
               updatePlaytimeCounter(formatSeconds(playtime));
               updatePlaytimeToday(slug);
               if (playtime % 10 === 1) refreshChart();
             }
           }, 1000);
         
           window.addEventListener('focus', refreshChart);
         }
         
         // --- MAIN LOADING ---
         fetch(gamesUrl)
           .then(r => r.json())
           .then(games => {
             const game = games.find(g => g.url === slug);
             if (!game) return showNotFound();
         
             document.getElementById("gameTitle").textContent = game.name;
             document.getElementById("gameAuthor").textContent = game.credits ? "" + game.credits : "";
             document.getElementById("frame").src = `/GameList.github.io/${game.url}/index.html`;
             document.getElementById("descDetails").textContent = game.gamedesc || "No description provided.";
             
         
             // Update Recently Played
             addRecentlyPlayed(game);
             loadRecentlyPlayed(slug, games);
         
             // ... recommendations as before ...
             let recTags = (game.tags || []).map(x => x.toLowerCase());
             let recommendations = games.filter(g2 =>
               g2.url !== game.url &&
               Array.isArray(g2.tags) &&
               g2.tags.some(tag => recTags.includes((tag || '').toLowerCase()))
             );
         
             recommendations = recommendations
               .map(g2=>({
                 ...g2,
                 matchCount: g2.tags.filter(t=>recTags.includes(t.toLowerCase())).length
               }))
               .sort((a,b)=>b.matchCount - a.matchCount)
               .slice(0, 4);
         
             const recList = document.getElementById('recommendedList');
             recList.innerHTML = "";
         
             if (recommendations.length === 0) {
               recList.innerHTML = `<span style='color:#f4b690;font-style:italic;font-size:1em;'>No related games found.</span>`;
             } else {
               recommendations.forEach(g2 => {
                 const thumbUrl = g2.thumb || "../assets/img/icon/main.png";
                 const el = document.createElement("a");
                 el.className = "recommend-game-link";
                 el.href = `play.html?game=${encodeURIComponent(g2.url)}`;
                 el.innerHTML = `
                   <img class="recommend-thumb" src="${thumbUrl}" alt="${g2.name} icon" loading="lazy">
                   <span>${g2.name}</span>
                 `;
                 recList.appendChild(el);
               });
             }
             // Playtime
             loadAndShowPlaytime(slug);
             getPlaytimeDays(slug).then(drawPlaytimeChart);
           })
           .catch(showNotFound);
         
         const minsAgo = Math.floor((Date.now() - g.time)/60000);
         const lastPlayed = minsAgo < 1 ? "Just now" : (minsAgo < 60 ? `${minsAgo}m ago` : `${Math.floor(minsAgo/60)}h ago`);
         a.innerHTML += `<div class="recent-last-played">${lastPlayed}</div>`;

         
      </script>
   </body>
</html>